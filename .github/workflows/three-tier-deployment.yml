# Three-Tier Deployment Pipeline
# Tier 1: Development (VM dev mode) - Manual, no CI/CD
# Tier 2: Staging (VM Docker) - Auto-deploy on develop branch
# Tier 3: Production (Cloud Run) - Auto-deploy on main branch with approval

name: Three-Tier Deployment

on:
  push:
    branches:
      - develop  # Triggers Tier 2 (VM Staging)
      - main     # Triggers Tier 3 (Cloud Run Production)
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:  # Manual trigger

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1

jobs:
  # ============================================================================
  # PHASE 1: CODE QUALITY & TESTING (Always runs first)
  # ============================================================================
  
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Validate poetry.lock
        working-directory: symphainy-platform
        run: |
          pip install tomli
          python3 scripts/validate-poetry-lock.py
      
      - name: Lint Python code
        run: |
          pip install flake8 black
          flake8 symphainy-platform --count --select=E9,F63,F7,F82 --show-source --statistics
          black --check symphainy-platform
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Lint frontend
        working-directory: symphainy-frontend
        run: |
          npm ci
          npm run lint || true

  backend-tests:
    name: Backend Tests (210 tests)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -r symphainy-platform/requirements.txt
          pip install pytest pytest-asyncio pytest-timeout
      
      - name: Run backend tests
        working-directory: tests
        run: |
          echo "üß™ Running backend tests..."
          pytest unit/ integration/ -v --timeout=60 || {
            echo "‚ùå Backend tests failed"
            exit 1
          }
          echo "‚úÖ Backend tests passed"

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install and test
        working-directory: symphainy-frontend
        run: |
          npm ci
          echo "üß™ Running frontend tests..."
          npm test -- --watchAll=false || {
            echo "‚ùå Frontend tests failed"
            exit 1
          }
          echo "‚úÖ Frontend tests passed"

  e2e-tests:
    name: E2E Tests (6 Critical)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio playwright
          playwright install chromium
          playwright install-deps
          cd symphainy-platform && pip install -r requirements.txt
          cd ../symphainy-frontend && npm ci
      
      - name: Start backend
        run: |
          cd symphainy-platform
          python3 main.py &
          echo $! > backend.pid
          sleep 10
      
      - name: Start frontend
        run: |
          cd symphainy-frontend
          npm run dev &
          echo $! > frontend.pid
          sleep 10
      
      - name: Run critical E2E tests
        working-directory: tests
        env:
          TEST_FRONTEND_URL: http://localhost:3000
          TEST_BACKEND_URL: http://localhost:8000
        run: |
          echo "üß™ Running critical E2E tests..."
          pytest e2e/test_complete_cto_demo_journey.py \
                 e2e/test_persistent_ui.py \
                 e2e/test_content_pillar_smoke.py \
                 e2e/test_insights_pillar_smoke.py \
                 e2e/test_operations_pillar_smoke.py \
                 e2e/test_business_outcomes_pillar_smoke.py \
                 -v -s --timeout=300 || {
            echo "‚ùå E2E tests failed"
            exit 1
          }
          echo "‚úÖ All critical E2E tests passed"
      
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-screenshots
          path: tests/screenshots/
      
      - name: Stop services
        if: always()
        run: |
          kill $(cat symphainy-platform/backend.pid) || true
          kill $(cat symphainy-frontend/frontend.pid) || true

  # ============================================================================
  # TIER 1.5: QUALITY GATES (Phase 3)
  # ============================================================================
  
  quality-gates:
    name: üéØ Quality Gates
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install security and quality tools
        run: |
          pip install --upgrade pip
          pip install bandit safety pip-audit black flake8
      
      - name: Run Bandit security scan
        working-directory: symphainy-platform
        continue-on-error: true
        run: |
          echo "üîí Running Bandit security scan..."
          bandit -r . -ll || {
            echo "‚ö†Ô∏è Bandit found security issues (non-blocking for now)"
          }
      
      - name: Run Safety dependency check
        working-directory: symphainy-platform
        run: |
          echo "üîí Checking dependencies for known vulnerabilities..."
          safety check || {
            echo "‚ùå Safety found vulnerable dependencies"
            exit 1
          }
          echo "‚úÖ Safety check passed"
      
      - name: Run pip-audit
        working-directory: symphainy-platform
        run: |
          echo "üîí Running pip-audit..."
          pip-audit --desc || {
            echo "‚ùå pip-audit found vulnerable dependencies"
            exit 1
          }
          echo "‚úÖ pip-audit passed"
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install frontend dependencies
        working-directory: symphainy-frontend
        run: npm ci
      
      - name: Run npm audit
        working-directory: symphainy-frontend
        run: |
          echo "üîí Running npm audit..."
          npm audit --audit-level=moderate || {
            echo "‚ùå npm audit found vulnerabilities"
            exit 1
          }
          echo "‚úÖ npm audit passed"
      
      - name: Check code formatting
        run: |
          echo "üé® Checking code formatting..."
          black --check symphainy-platform tests || {
            echo "‚ùå Code formatting check failed"
            exit 1
          }
          echo "‚úÖ Code formatting check passed"
      
      - name: Run flake8 critical checks
        run: |
          echo "üîç Running flake8 critical checks..."
          flake8 symphainy-platform --count --select=E9,F63,F7,F82 --show-source --statistics || {
            echo "‚ùå Flake8 found critical errors"
            exit 1
          }
          echo "‚úÖ Flake8 critical checks passed"

  # ============================================================================
  # TIER 1.6: TEST ENVIRONMENT VALIDATION (before staging)
  # ============================================================================
  
  test-environment-validation:
    name: üß™ Test Environment Validation
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, quality-gates]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Start test infrastructure
        run: |
          echo "üèóÔ∏è Starting test infrastructure..."
          docker-compose -f docker-compose.test.yml up -d redis arangodb consul meilisearch
          sleep 30
      
      - name: Build and start test environment
        run: |
          echo "üèóÔ∏è Building application containers..."
          docker-compose -f docker-compose.test.yml build backend frontend
          echo "üöÄ Starting application services..."
          docker-compose -f docker-compose.test.yml up -d backend frontend
          sleep 60
      
      - name: Wait for services
        run: |
          echo "‚è≥ Waiting for test environment services..."
          timeout 180 bash -c 'until curl -f http://localhost:8001/health 2>/dev/null; do sleep 3; done' || {
            echo "‚ùå Backend not ready in test environment"
            docker logs symphainy-backend-test 2>&1 | tail -50
            exit 1
          }
          timeout 120 bash -c 'until curl -f http://localhost:3001 2>/dev/null; do sleep 3; done' || {
            echo "‚ùå Frontend not ready in test environment"
            docker logs symphainy-frontend-test 2>&1 | tail -50
            exit 1
          }
          echo "‚úÖ Test environment services are ready"
      
      - name: Run smoke tests in test environment
        working-directory: tests
        env:
          TEST_BACKEND_URL: http://localhost:8001
          TEST_FRONTEND_URL: http://localhost:3001
        run: |
          echo "üß™ Running smoke tests in test environment..."
          pip install pytest pytest-asyncio pytest-timeout httpx
          # Run test environment smoke tests
          pytest e2e/test_environment_smoke_tests.py -v --timeout=180 || {
            echo "‚ùå Smoke tests failed in test environment"
            exit 1
          }
          # Run production smoke tests if they exist
          if [ -d "e2e/production/smoke_tests" ]; then
            pytest e2e/production/smoke_tests/ -v --timeout=180 || {
              echo "‚ùå Production smoke tests failed in test environment"
              exit 1
            }
          fi
          echo "‚úÖ Smoke tests passed"
      
      - name: Cleanup test environment
        if: always()
        run: |
          echo "üßπ Cleaning up test environment..."
          docker-compose -f docker-compose.test.yml down -v || true

  # ============================================================================
  # TIER 2: DEPLOY TO VM STAGING (develop branch only)
  # ============================================================================
  
  deploy-to-vm-staging:
    name: üöÄ Tier 2 - Deploy to VM Staging
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, quality-gates, test-environment-validation]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: vm-staging
      url: http://${{ secrets.GCP_VM_IP }}:3000
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_VM_USERNAME }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          script: |
            echo "üöÄ Starting VM Staging Deployment"
            
            # Navigate to project directory
            cd /home/founders/demoversion/symphainy_source
            
            # Pull latest code
            echo "üì• Pulling latest code from develop branch..."
            git fetch origin
            git checkout develop
            git pull origin develop
            
            # Stop existing staging containers (if running)
            echo "üõë Stopping existing staging containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            # Remove old images to ensure fresh build
            docker system prune -f
            
            # Build and start new containers
            echo "üèóÔ∏è  Building new Docker containers..."
            docker-compose -f docker-compose.prod.yml build --no-cache
            
            echo "‚ñ∂Ô∏è  Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # Wait for containers to be healthy
            echo "‚è≥ Waiting for containers to be healthy..."
            sleep 30
            
            # Check health
            echo "üè• Health check..."
            curl -f http://localhost:8000/health || echo "‚ö†Ô∏è  Backend health check failed"
            curl -f http://localhost:3000 || echo "‚ö†Ô∏è  Frontend health check failed"
            
            # Show container status
            echo "üìä Container status:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo "‚úÖ VM Staging deployment complete!"
            echo "üåê Access at: http://${{ secrets.GCP_VM_IP }}:3000"
      
      - name: Run smoke tests on VM staging
        run: |
          echo "Running smoke tests on VM staging..."
          
          # Test backend health
          curl -f http://${{ secrets.GCP_VM_IP }}:8000/health || exit 1
          
          # Test frontend loads
          curl -f http://${{ secrets.GCP_VM_IP }}:3000 || exit 1
          
          echo "‚úÖ Smoke tests passed!"
      
      - name: Comment on commit with deployment info
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå';
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `${status} **VM Staging Deployment ${status === '‚úÖ' ? 'Successful' : 'Failed'}**
              
              Branch: develop
              
              ${status === '‚úÖ' ? `
              **Access staging environment:**
              - Backend: http://${{ secrets.GCP_VM_IP }}:8000
              - Frontend: http://${{ secrets.GCP_VM_IP }}:3000
              
              Please validate before merging to main!
              ` : 'Check workflow logs for details.'}`
            })

  # ============================================================================
  # TIER 3: DEPLOY TO CLOUD RUN PRODUCTION (main branch only)
  # ============================================================================
  
  deploy-to-cloud-run-production:
    name: üéØ Tier 3 - Deploy to Cloud Run Production
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, quality-gates, test-environment-validation]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://symphainy.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker
      
      - name: Build and push backend container
        run: |
          echo "üèóÔ∏è  Building backend container..."
          cd symphainy-platform
          docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-backend:${{ github.sha }} .
          docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-backend:latest .
          
          echo "üì§ Pushing to Google Container Registry..."
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-backend:${{ github.sha }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-backend:latest
      
      - name: Build and push frontend container
        run: |
          echo "üèóÔ∏è  Building frontend container..."
          cd symphainy-frontend
          docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-frontend:${{ github.sha }} .
          docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-frontend:latest .
          
          echo "üì§ Pushing to Google Container Registry..."
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-frontend:${{ github.sha }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-frontend:latest
      
      - name: Deploy backend to Cloud Run
        run: |
          echo "üöÄ Deploying backend to Cloud Run..."
          gcloud run deploy symphainy-backend \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-backend:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars ENVIRONMENT=production \
            --min-instances 1 \
            --max-instances 100 \
            --memory 2Gi \
            --cpu 2 \
            --timeout 300
          
          # Get the backend URL
          BACKEND_URL=$(gcloud run services describe symphainy-backend \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          
          echo "Backend URL: $BACKEND_URL"
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
      
      - name: Deploy frontend to Cloud Run
        run: |
          echo "üöÄ Deploying frontend to Cloud Run..."
          gcloud run deploy symphainy-frontend \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/symphainy-frontend:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars NEXT_PUBLIC_API_URL=${{ env.BACKEND_URL }} \
            --min-instances 1 \
            --max-instances 100 \
            --memory 1Gi \
            --cpu 1 \
            --timeout 300
          
          # Get the frontend URL
          FRONTEND_URL=$(gcloud run services describe symphainy-frontend \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          
          echo "Frontend URL: $FRONTEND_URL"
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV
      
      - name: Run production smoke tests
        run: |
          echo "üè• Running production smoke tests..."
          
          # Wait for services to be ready
          sleep 30
          
          # Test backend
          curl -f ${{ env.BACKEND_URL }}/health || exit 1
          
          # Test frontend
          curl -f ${{ env.FRONTEND_URL }} || exit 1
          
          echo "‚úÖ Production smoke tests passed!"
      
      - name: Comment on commit with production info
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå';
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `${status} **Production Deployment ${status === '‚úÖ' ? 'Successful' : 'Failed'}**
              
              Branch: main
              
              ${status === '‚úÖ' ? `
              **Live URLs:**
              - Backend: ${{ env.BACKEND_URL }}
              - Frontend: ${{ env.FRONTEND_URL }}
              
              üéâ Production is live at: https://symphainy.com
              ` : 'Check workflow logs for details.'}`
            })
      
      - name: Create deployment record
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              description: 'Deployed to Cloud Run',
              auto_merge: false,
              required_contexts: []
            })

  # ============================================================================
  # NOTIFICATION & REPORTING
  # ============================================================================
  
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests]
    if: failure()
    steps:
      - name: Create GitHub issue on test failure
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® CI/CD Pipeline Failed',
              body: `Pipeline failed on ${context.ref}
              
              **Commit:** ${context.sha}
              **Workflow:** ${context.workflow}
              **Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              Please investigate and fix.`,
              labels: ['bug', 'ci-cd', 'urgent']
            })
      
      - name: Comment on commit about failure
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `üö® **Pipeline Failed**
              
              Branch: ${{ github.ref }}
              
              [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              Please investigate and fix.`
            })

