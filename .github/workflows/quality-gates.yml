# Quality Gates Workflow
# Enforces code quality, security, and performance standards
# Runs after tests pass, before deployment (Phase 3: Quality Gates)

name: Quality Gates

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'
  COVERAGE_THRESHOLD: 80  # Minimum code coverage percentage

jobs:
  # ============================================================================
  # JOB 1: CODE COVERAGE VALIDATION
  # ============================================================================
  code-coverage:
    name: Code Coverage Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install backend dependencies
        run: |
          pip install --upgrade pip
          pip install -r symphainy-platform/requirements.txt
          pip install pytest pytest-cov coverage
      
      - name: Run tests with coverage
        working-directory: tests
        run: |
          echo "ðŸ“Š Running tests with coverage..."
          pytest unit/ integration/ -v \
            --cov=../symphainy-platform \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} || {
            echo "âŒ Code coverage below ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          }
          echo "âœ… Code coverage meets ${{ env.COVERAGE_THRESHOLD }}% threshold"
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            tests/coverage.xml
            tests/htmlcov/
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install frontend dependencies
        working-directory: symphainy-frontend
        run: npm ci
      
      - name: Run frontend tests with coverage
        working-directory: symphainy-frontend
        run: |
          echo "ðŸ“Š Running frontend tests with coverage..."
          npm test -- --coverage --watchAll=false --coverageThreshold='{"global":{"branches":${{ env.COVERAGE_THRESHOLD }},"functions":${{ env.COVERAGE_THRESHOLD }},"lines":${{ env.COVERAGE_THRESHOLD }},"statements":${{ env.COVERAGE_THRESHOLD }}}' || {
            echo "âŒ Frontend code coverage below ${{ env.COVERAGE_THRESHOLD }}%"
            exit 1
          }
          echo "âœ… Frontend code coverage meets ${{ env.COVERAGE_THRESHOLD }}% threshold"
      
      - name: Upload frontend coverage
        uses: actions/upload-artifact@v3
        with:
          name: frontend-coverage-reports
          path: symphainy-frontend/coverage/

  # ============================================================================
  # JOB 2: SECURITY SCANNING
  # ============================================================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install security tools
        run: |
          pip install --upgrade pip
          pip install bandit safety pip-audit
      
      - name: Run Bandit security scan
        working-directory: symphainy-platform
        run: |
          echo "ðŸ”’ Running Bandit security scan..."
          bandit -r . -f json -o bandit-report.json || {
            echo "âŒ Bandit found security issues"
            exit 1
          }
          bandit -r . -ll || {
            echo "âŒ Bandit found high/critical security issues"
            exit 1
          }
          echo "âœ… Bandit security scan passed"
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v3
        with:
          name: bandit-security-report
          path: symphainy-platform/bandit-report.json
      
      - name: Run Safety dependency check
        working-directory: symphainy-platform
        run: |
          echo "ðŸ”’ Checking dependencies for known vulnerabilities..."
          safety check --json --output safety-report.json || {
            echo "âŒ Safety found vulnerable dependencies"
            cat safety-report.json || true
            exit 1
          }
          echo "âœ… Safety check passed - no vulnerable dependencies"
      
      - name: Upload Safety report
        uses: actions/upload-artifact@v3
        with:
          name: safety-dependency-report
          path: symphainy-platform/safety-report.json
      
      - name: Run pip-audit
        working-directory: symphainy-platform
        run: |
          echo "ðŸ”’ Running pip-audit for dependency vulnerabilities..."
          pip-audit --desc --format=json --output=audit-report.json || {
            echo "âŒ pip-audit found vulnerable dependencies"
            cat audit-report.json || true
            exit 1
          }
          echo "âœ… pip-audit passed - no vulnerable dependencies"
      
      - name: Upload pip-audit report
        uses: actions/upload-artifact@v3
        with:
          name: pip-audit-report
          path: symphainy-platform/audit-report.json
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install frontend dependencies
        working-directory: symphainy-frontend
        run: npm ci
      
      - name: Run npm audit
        working-directory: symphainy-frontend
        run: |
          echo "ðŸ”’ Running npm audit for frontend vulnerabilities..."
          npm audit --audit-level=moderate --json > npm-audit-report.json || {
            echo "âŒ npm audit found vulnerabilities"
            npm audit --audit-level=moderate || true
            exit 1
          }
          echo "âœ… npm audit passed - no moderate/high/critical vulnerabilities"
      
      - name: Upload npm audit report
        uses: actions/upload-artifact@v3
        with:
          name: npm-audit-report
          path: symphainy-frontend/npm-audit-report.json

  # ============================================================================
  # JOB 3: CODE QUALITY CHECKS
  # ============================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install code quality tools
        run: |
          pip install --upgrade pip
          pip install black flake8 pylint mypy
      
      - name: Check code formatting with black
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          black --check symphainy-platform tests || {
            echo "âŒ Code formatting check failed"
            echo "Run 'black symphainy-platform tests' to fix"
            exit 1
          }
          echo "âœ… Code formatting check passed"
      
      - name: Run flake8 linting
        run: |
          echo "ðŸ” Running flake8 linting..."
          flake8 symphainy-platform --count --select=E9,F63,F7,F82 --show-source --statistics || {
            echo "âŒ Flake8 found critical errors"
            exit 1
          }
          echo "âœ… Flake8 critical checks passed"
      
      - name: Run pylint (non-blocking)
        continue-on-error: true
        run: |
          echo "ðŸ” Running pylint..."
          pylint symphainy-platform --fail-under=8.0 || {
            echo "âš ï¸ Pylint score below 8.0 (non-blocking)"
          }
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install frontend dependencies
        working-directory: symphainy-frontend
        run: npm ci
      
      - name: Run ESLint
        working-directory: symphainy-frontend
        run: |
          echo "ðŸ” Running ESLint..."
          npm run lint || {
            echo "âŒ ESLint found errors"
            exit 1
          }
          echo "âœ… ESLint passed"

  # ============================================================================
  # JOB 4: PERFORMANCE BENCHMARKS
  # ============================================================================
  performance-checks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r symphainy-platform/requirements.txt
          pip install pytest pytest-benchmark
      
      - name: Run performance benchmarks
        working-directory: tests
        continue-on-error: true
        run: |
          echo "âš¡ Running performance benchmarks..."
          # Run tests with benchmark plugin
          pytest unit/ -v --benchmark-only --benchmark-autosave || {
            echo "âš ï¸ Performance benchmarks completed (non-blocking)"
          }
          echo "âœ… Performance benchmarks completed"
      
      - name: Check test execution time
        working-directory: tests
        run: |
          echo "â±ï¸ Checking test execution times..."
          pytest unit/ -v --durations=10 || {
            echo "âŒ Tests took too long"
            exit 1
          }
          echo "âœ… Test execution times acceptable"

  # ============================================================================
  # JOB 5: QUALITY GATES SUMMARY
  # ============================================================================
  quality-gates-summary:
    name: Quality Gates Summary
    runs-on: ubuntu-latest
    needs: [code-coverage, security-scan, code-quality, performance-checks]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Code Coverage: ${{ needs.code-coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: ${{ needs.performance-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.code-coverage.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ] && \
             [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "âœ… **Quality Gates: PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All quality gates passed. Ready for deployment!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Quality Gates: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more quality gates failed. Review and fix issues before deployment." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi






