# Test Environment Deployment and Validation Workflow
# Deploys to test environment and validates before production
# Runs after all tests pass (Phase 2: Test Environment)

name: Test Environment Validation

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'
  TEST_BACKEND_PORT: 8001
  TEST_FRONTEND_PORT: 3001

jobs:
  # ============================================================================
  # JOB 1: DEPLOY TO TEST ENVIRONMENT
  # ============================================================================
  deploy-test-environment:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    # Only run if previous jobs (tests) passed
    # This job should be triggered after: lint, backend-tests, frontend-tests, e2e-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Start test infrastructure
        run: |
          echo "ðŸ—ï¸ Starting test infrastructure services..."
          docker-compose -f docker-compose.test.yml up -d redis arangodb consul meilisearch
          
          echo "â³ Waiting for infrastructure services to be healthy..."
          timeout 120 bash -c 'until docker ps --filter "name=symphainy-test-redis" --filter "health=healthy" --format "{{.Names}}" | grep -q "symphainy-test-redis"; do sleep 2; done' || {
            echo "âŒ Redis failed to start"
            docker logs symphainy-test-redis 2>&1 | tail -20
            exit 1
          }
          
          timeout 120 bash -c 'until docker ps --filter "name=symphainy-test-arangodb" --filter "health=healthy" --format "{{.Names}}" | grep -q "symphainy-test-arangodb"; do sleep 2; done' || {
            echo "âŒ ArangoDB failed to start"
            docker logs symphainy-test-arangodb 2>&1 | tail -20
            exit 1
          }
          
          timeout 120 bash -c 'until docker ps --filter "name=symphainy-test-consul" --filter "health=healthy" --format "{{.Names}}" | grep -q "symphainy-test-consul"; do sleep 2; done' || {
            echo "âŒ Consul failed to start"
            docker logs symphainy-test-consul 2>&1 | tail -20
            exit 1
          }
          
          echo "âœ… Infrastructure services are healthy"
      
      - name: Build application containers
        run: |
          echo "ðŸ—ï¸ Building application containers for test environment..."
          docker-compose -f docker-compose.test.yml build backend frontend
      
      - name: Start application services
        run: |
          echo "ðŸš€ Starting application services in test environment..."
          docker-compose -f docker-compose.test.yml up -d backend frontend
          
          echo "â³ Waiting for application services to be healthy..."
          timeout 180 bash -c 'until docker ps --filter "name=symphainy-backend-test" --filter "health=healthy" --format "{{.Names}}" | grep -q "symphainy-backend-test"; do sleep 3; done' || {
            echo "âŒ Backend failed to start in test environment"
            docker logs symphainy-backend-test 2>&1 | tail -50
            exit 1
          }
          echo "âœ… Backend is healthy"
          
          timeout 120 bash -c 'until docker ps --filter "name=symphainy-frontend-test" --filter "health=healthy" --format "{{.Names}}" | grep -q "symphainy-frontend-test"; do sleep 3; done' || {
            echo "âŒ Frontend failed to start in test environment"
            docker logs symphainy-frontend-test 2>&1 | tail -50
            exit 1
          }
          echo "âœ… Frontend is healthy"
      
      - name: Show test environment status
        run: |
          echo "ðŸ“Š Test Environment Status:"
          docker-compose -f docker-compose.test.yml ps
          echo ""
          echo "ðŸŒ Test Environment URLs:"
          echo "  Backend: http://localhost:${{ env.TEST_BACKEND_PORT }}/health"
          echo "  Frontend: http://localhost:${{ env.TEST_FRONTEND_PORT }}"

  # ============================================================================
  # JOB 2: RUN SMOKE TESTS IN TEST ENVIRONMENT
  # ============================================================================
  smoke-tests:
    name: Smoke Tests in Test Environment
    runs-on: ubuntu-latest
    needs: deploy-test-environment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio pytest-timeout httpx
      
      - name: Wait for services to be ready
        run: |
          echo "â³ Waiting for test environment services..."
          sleep 10
          
          # Test backend health
          for i in {1..30}; do
            if curl -f http://localhost:${{ env.TEST_BACKEND_PORT }}/health 2>/dev/null; then
              echo "âœ… Backend is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Backend not ready after 30 attempts"
              exit 1
            fi
            sleep 2
          done
          
          # Test frontend
          for i in {1..30}; do
            if curl -f http://localhost:${{ env.TEST_FRONTEND_PORT }} 2>/dev/null; then
              echo "âœ… Frontend is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Frontend not ready after 30 attempts"
              exit 1
            fi
            sleep 2
          done
      
      - name: Run smoke tests
        working-directory: tests
        env:
          TEST_BACKEND_URL: http://localhost:${{ env.TEST_BACKEND_PORT }}
          TEST_FRONTEND_URL: http://localhost:${{ env.TEST_FRONTEND_PORT }}
        run: |
          echo "ðŸ§ª Running smoke tests in test environment..."
          pip install pytest pytest-asyncio pytest-timeout httpx
          # Run test environment smoke tests
          pytest e2e/test_environment_smoke_tests.py -v --timeout=180 || {
            echo "âŒ Smoke tests failed in test environment"
            exit 1
          }
          # Run production smoke tests if they exist
          if [ -d "e2e/production/smoke_tests" ]; then
            pytest e2e/production/smoke_tests/ -v --timeout=180 || {
              echo "âŒ Production smoke tests failed in test environment"
              exit 1
            }
          fi
          echo "âœ… Smoke tests passed"

  # ============================================================================
  # JOB 3: RUN INTEGRATION TESTS IN TEST ENVIRONMENT
  # ============================================================================
  integration-tests:
    name: Integration Tests in Test Environment
    runs-on: ubuntu-latest
    needs: deploy-test-environment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio pytest-timeout httpx
      
      - name: Run integration tests
        working-directory: tests
        env:
          TEST_BACKEND_URL: http://localhost:${{ env.TEST_BACKEND_PORT }}
          TEST_FRONTEND_URL: http://localhost:${{ env.TEST_FRONTEND_PORT }}
          ENVIRONMENT: test
        run: |
          echo "ðŸ§ª Running integration tests in test environment..."
          pytest integration/ -v --timeout=120 || {
            echo "âŒ Integration tests failed in test environment"
            exit 1
          }
          echo "âœ… Integration tests passed"

  # ============================================================================
  # JOB 4: TEST ENVIRONMENT VALIDATION SUMMARY
  # ============================================================================
  test-environment-summary:
    name: Test Environment Validation Summary
    runs-on: ubuntu-latest
    needs: [smoke-tests, integration-tests]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# Test Environment Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.smoke-tests.result }}" == "success" ] && [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "âœ… **Test Environment Validation: PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Ready for production deployment!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Test Environment Validation: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Do not proceed to production deployment." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Cleanup test environment
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up test environment..."
          docker-compose -f docker-compose.test.yml down -v || true
          docker system prune -f || true

