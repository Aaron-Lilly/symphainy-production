name: Experience Domain CI/CD

on:
  push:
    paths:
      - 'experience/**'
      - 'frontend/**'
      - 'foundations/**'
  pull_request:
    paths:
      - 'experience/**'
      - 'frontend/**'
      - 'foundations/**'

jobs:
  experience-ci:
    runs-on: ubuntu-latest
    name: Experience Domain CI
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
      
      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root
      
      - name: Install project
        run: poetry install --no-interaction
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run Experience Unit Tests
        run: |
          poetry run python -m pytest tests/experience/unit/ -v --tb=short
      
      - name: Run Experience Integration Tests
        run: |
          poetry run python -m pytest tests/experience/integration/ -v --tb=short
      
      - name: Run Experience Chaos Tests
        run: |
          poetry run python -m pytest tests/experience/chaos/ -v --tb=short
      
      - name: Run Experience Blue-Green Tests
        run: |
          poetry run python -m pytest tests/experience/blue-green/ -v --tb=short
      
      - name: Run Frontend Tests
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false
      
      - name: Validate Domain Boundaries
        run: |
          poetry run python -c "
          import sys
          sys.path.append('.')
          from foundations.public_works_foundation.public_works_foundation_service import PublicWorksFoundationService
          from foundations.di_container.di_container_service import DIContainerService
          
          # Test that Experience gets its specific abstractions
          di_container = DIContainerService('test')
          public_works = PublicWorksFoundationService(di_container)
          experience_abstractions = public_works.get_experience_abstractions()
          
          # Verify Experience abstractions are available
          assert 'cross_dimensional_orchestration' in experience_abstractions, 'Cross-dimensional orchestration abstraction missing'
          assert 'platform_coordination' in experience_abstractions, 'Platform coordination abstraction missing'
          assert 'analytics' in experience_abstractions, 'Analytics abstraction missing'
          assert 'visualization' in experience_abstractions, 'Visualization abstraction missing'
          
          print('âœ… Experience domain boundaries validated')
          print(f'âœ… Experience has {len(experience_abstractions)} abstractions')
          "
      
      - name: Run Code Quality Checks
        run: |
          poetry run black --check experience/ foundations/
          poetry run isort --check-only experience/ foundations/
          poetry run flake8 experience/ foundations/
          poetry run mypy experience/ foundations/
      
      - name: Run Frontend Linting
        run: |
          cd frontend
          npm run lint
          npm run type-check
      
      - name: Run Security Scans
        run: |
          poetry run bandit -r experience/ foundations/
          poetry run safety check
          poetry run pip-audit
          cd frontend
          npm audit
      
      - name: Generate Test Coverage Report
        run: |
          poetry run pytest --cov=experience --cov=foundations --cov-report=xml --cov-report=html
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: experience
          name: experience-coverage

  experience-cd:
    runs-on: ubuntu-latest
    name: Experience Domain CD
    needs: experience-ci
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install dependencies
        run: poetry install --no-interaction
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build Frontend
        run: |
          cd frontend
          npm run build
      
      - name: Deploy Experience Services
        run: |
          echo "ðŸš€ Deploying Experience services..."
          # This would integrate with our CI/CD business abstractions
          poetry run python -c "
          import sys
          sys.path.append('.')
          from foundations.public_works_foundation.public_works_foundation_service import PublicWorksFoundationService
          from foundations.di_container.di_container_service import DIContainerService
          
          # Get abstractions for deployment
          di_container = DIContainerService('deployment')
          public_works = PublicWorksFoundationService(di_container)
          experience_abstractions = public_works.get_experience_abstractions()
          
          # Use Experience abstractions for deployment
          cross_dimensional = experience_abstractions.get('cross_dimensional_orchestration')
          platform_coordination = experience_abstractions.get('platform_coordination')
          
          print('âœ… Experience deployment using abstractions')
          print(f'âœ… Cross-dimensional orchestration available: {cross_dimensional is not None}')
          print(f'âœ… Platform coordination available: {platform_coordination is not None}')
          "
      
      - name: Run Post-Deployment Tests
        run: |
          poetry run python -m pytest tests/experience/blue-green/ -v --tb=short
      
      - name: Notify Deployment Success
        run: |
          echo "âœ… Experience domain deployment successful"
          echo "ðŸ”— Experience services are now available"




