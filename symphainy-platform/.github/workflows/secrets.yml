name: Secrets Management

on:
  workflow_dispatch:
  push:
    branches: [ main, production ]
  pull_request:
    branches: [ main ]

jobs:
  secrets-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate secrets configuration
      run: |
        echo "üîê Validating secrets configuration..."
        
        # Check if required secrets are set
        if [ -z "${{ secrets.DATABASE_URL }}" ]; then
          echo "‚ùå DATABASE_URL secret not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.REDIS_URL }}" ]; then
          echo "‚ùå REDIS_URL secret not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.SECRET_KEY }}" ]; then
          echo "‚ùå SECRET_KEY secret not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.JWT_SECRET }}" ]; then
          echo "‚ùå JWT_SECRET secret not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
          echo "‚ùå SUPABASE_URL secret not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.SUPABASE_KEY }}" ]; then
          echo "‚ùå SUPABASE_KEY secret not set"
          exit 1
        fi
        
        echo "‚úÖ All required secrets are configured"
        
    - name: Test configuration loading
      run: |
        echo "üß™ Testing configuration loading..."
        python3 -c "
        from utilities.configuration.unified_configuration_manager import UnifiedConfigurationManager
        config = UnifiedConfigurationManager('test')
        print('‚úÖ Configuration system working')
        print(f'Environment: {config.get_environment().value}')
        print(f'Total config values: {len(config.config_cache)}')
        "
        
    - name: Security scan
      run: |
        echo "üîç Scanning for hardcoded secrets..."
        
        # Check for hardcoded secrets in code
        if grep -r "sk-" . --exclude-dir=.git --exclude-dir=poetry_lib --exclude-dir=__pycache__; then
          echo "‚ùå Found hardcoded API keys"
          exit 1
        fi
        
        if grep -r "password.*=" . --exclude-dir=.git --exclude-dir=poetry_lib --exclude-dir=__pycache__; then
          echo "‚ùå Found hardcoded passwords"
          exit 1
        fi
        
        echo "‚úÖ No hardcoded secrets found"




