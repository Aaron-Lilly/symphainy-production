name: Business Enablement Domain CI/CD

on:
  push:
    paths:
      - 'backend/business_enablement/**'
      - 'backend/packages/**'
      - 'foundations/**'
  pull_request:
    paths:
      - 'backend/business_enablement/**'
      - 'backend/packages/**'
      - 'foundations/**'

jobs:
  business-enablement-ci:
    runs-on: ubuntu-latest
    name: Business Enablement Domain CI
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
      
      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root
      
      - name: Install project
        run: poetry install --no-interaction
      
      - name: Run Business Enablement Unit Tests
        run: |
          poetry run python -m pytest tests/business-enablement/unit/ -v --tb=short
      
      - name: Run Business Enablement Integration Tests
        run: |
          poetry run python -m pytest tests/business-enablement/integration/ -v --tb=short
      
      - name: Run Business Enablement Chaos Tests
        run: |
          poetry run python -m pytest tests/business-enablement/chaos/ -v --tb=short
      
      - name: Run Business Enablement Blue-Green Tests
        run: |
          poetry run python -m pytest tests/business-enablement/blue-green/ -v --tb=short
      
      - name: Validate Domain Boundaries
        run: |
          poetry run python -c "
          import sys
          sys.path.append('.')
          from foundations.public_works_foundation.public_works_foundation_service import PublicWorksFoundationService
          from foundations.di_container.di_container_service import DIContainerService
          
          # Test that Business Enablement gets specific abstractions (including CI/CD)
          di_container = DIContainerService('test')
          public_works = PublicWorksFoundationService(di_container)
          business_abstractions = public_works.get_business_enablement_abstractions()
          
          # Verify CI/CD abstractions are available for Business Enablement
          assert 'cicd_monitoring' in business_abstractions, 'CI/CD monitoring abstraction missing'
          assert 'deployment_management' in business_abstractions, 'Deployment management abstraction missing'
          
          # Verify other Business Enablement abstractions
          assert 'content_processing' in business_abstractions, 'Content processing abstraction missing'
          assert 'business_intelligence' in business_abstractions, 'Business intelligence abstraction missing'
          
          print('âœ… Business Enablement domain boundaries validated')
          print(f'âœ… Business Enablement has {len(business_abstractions)} abstractions (including CI/CD)')
          "
      
      - name: Run Code Quality Checks
        run: |
          poetry run black --check backend/business_enablement/ backend/packages/ foundations/
          poetry run isort --check-only backend/business_enablement/ backend/packages/ foundations/
          poetry run flake8 backend/business_enablement/ backend/packages/ foundations/
          poetry run mypy backend/business_enablement/ backend/packages/ foundations/
      
      - name: Run Security Scans
        run: |
          poetry run bandit -r backend/business_enablement/ backend/packages/ foundations/
          poetry run safety check
          poetry run pip-audit
      
      - name: Generate Test Coverage Report
        run: |
          poetry run pytest --cov=backend/business_enablement --cov=backend/packages --cov=foundations --cov-report=xml --cov-report=html
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: business-enablement
          name: business-enablement-coverage

  business-enablement-cd:
    runs-on: ubuntu-latest
    name: Business Enablement Domain CD
    needs: business-enablement-ci
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install dependencies
        run: poetry install --no-interaction
      
      - name: Deploy Business Enablement Services
        run: |
          echo "ðŸš€ Deploying Business Enablement services..."
          # This would integrate with our CI/CD business abstractions
          poetry run python -c "
          import sys
          sys.path.append('.')
          from foundations.public_works_foundation.public_works_foundation_service import PublicWorksFoundationService
          from foundations.di_container.di_container_service import DIContainerService
          
          # Get CI/CD abstractions for deployment
          di_container = DIContainerService('deployment')
          public_works = PublicWorksFoundationService(di_container)
          business_abstractions = public_works.get_business_enablement_abstractions()
          
          # Use CI/CD monitoring abstraction for deployment tracking
          cicd_monitoring = business_abstractions.get('cicd_monitoring')
          deployment_management = business_abstractions.get('deployment_management')
          
          print('âœ… Business Enablement deployment using CI/CD abstractions')
          print(f'âœ… CI/CD monitoring available: {cicd_monitoring is not None}')
          print(f'âœ… Deployment management available: {deployment_management is not None}')
          "
      
      - name: Run Post-Deployment Tests
        run: |
          poetry run python -m pytest tests/business-enablement/blue-green/ -v --tb=short
      
      - name: Notify Deployment Success
        run: |
          echo "âœ… Business Enablement domain deployment successful"
          echo "ðŸ”— Business Enablement services are now available"




