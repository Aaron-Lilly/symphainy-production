name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Code Quality and Security
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality & Security
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
      
    - name: Validate poetry.lock
      run: |
        pip install tomli
        cd symphainy-platform
        python3 scripts/validate-poetry-lock.py
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
        
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --only main
      
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit == 'true'
      run: poetry install --only main
      
    - name: Code formatting check
      run: |
        echo "ğŸ” Checking code formatting..."
        poetry run black --check .
        poetry run isort --check-only .
        
    - name: Linting
      run: |
        echo "ğŸ” Running linters..."
        poetry run flake8 .
        poetry run pylint --fail-under=8.0 .
        
    - name: Security scan
      run: |
        echo "ğŸ” Running security scan..."
        poetry run bandit -r . -f json -o bandit-report.json || true
        poetry run safety check --json --output safety-report.json || true
        
    - name: Type checking
      run: |
        echo "ğŸ” Running type checks..."
        poetry run mypy . --ignore-missing-imports
        
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # Testing
  testing:
    runs-on: ubuntu-latest
    name: Testing
    needs: code-quality
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      arangodb:
        image: arangodb:3.11
        ports:
          - 8529:8529
        env:
          ARANGO_ROOT_PASSWORD: rootpassword
          ARANGO_NO_AUTH: 1
        options: >-
          --health-cmd "curl -f http://localhost:8529/_api/version"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Run unit tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        poetry run pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html
        
    - name: Run integration tests
      run: |
        echo "ğŸ§ª Running integration tests..."
        poetry run pytest tests/integration/ -v
        
    - name: Run architecture tests
      run: |
        echo "ğŸ§ª Running architecture tests..."
        poetry run pytest tests/architecture/ -v
        
    - name: Run contract tests
      run: |
        echo "ğŸ§ª Running contract tests..."
        poetry run pytest tests/contracts/ -v
        
    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/

  # Configuration Validation
  config-validation:
    runs-on: ubuntu-latest
    name: Configuration Validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Validate configuration system
      run: |
        echo "ğŸ”§ Validating configuration system..."
        poetry run python -c "
        from utilities.configuration.unified_configuration_manager import UnifiedConfigurationManager
        config = UnifiedConfigurationManager('test')
        print(f'âœ… Configuration loaded: {len(config.config_cache)} values')
        print(f'âœ… Environment: {config.get_environment().value}')
        "
        
    - name: Validate DI Container
      run: |
        echo "ğŸ”§ Validating DI Container..."
        poetry run python -c "
        from foundations.di_container.di_container_service import DIContainerService
        di = DIContainerService('test')
        print('âœ… DI Container initialized')
        print('âœ… All utilities working')
        "
        
    - name: Validate secrets management
      run: |
        echo "ğŸ”§ Validating secrets management..."
        chmod +x scripts/load-secrets.sh
        ./scripts/load-secrets.sh || echo "âš ï¸ Secrets loading requires environment variables"
        
    - name: Validate Docker configurations
      run: |
        echo "ğŸ”§ Validating Docker configurations..."
        docker-compose -f docker-compose.dev.yml config
        docker-compose -f docker-compose.prod.yml config

  # Performance Testing
  performance:
    runs-on: ubuntu-latest
    name: Performance Testing
    needs: [code-quality, testing]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Run performance tests
      run: |
        echo "âš¡ Running performance tests..."
        poetry run pytest tests/performance/ -v --durations=10
        
    - name: Load testing
      run: |
        echo "âš¡ Running load tests..."
        poetry run python monitoring/health-checks.py

  # Final Validation
  final-validation:
    runs-on: ubuntu-latest
    name: Final Validation
    needs: [code-quality, testing, config-validation, performance]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Run production validation
      run: |
        echo "ğŸ¯ Running production validation..."
        chmod +x scripts/production-validation.sh
        ./scripts/production-validation.sh
        
    - name: Generate CI report
      run: |
        echo "ğŸ“Š Generating CI report..."
        echo "âœ… Code Quality: PASSED"
        echo "âœ… Testing: PASSED"
        echo "âœ… Configuration: PASSED"
        echo "âœ… Performance: PASSED"
        echo "âœ… Final Validation: PASSED"
        echo ""
        echo "ğŸ‰ CI Pipeline: SUCCESS"
        echo "ğŸš€ Ready for deployment!"




