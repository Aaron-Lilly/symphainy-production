name: Continuous Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  # Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and Test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Validate poetry.lock
      run: |
        pip install tomli
        cd symphainy-platform
        python3 scripts/validate-poetry-lock.py
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Run tests
      run: |
        echo "ğŸ§ª Running tests..."
        poetry run pytest tests/ -v --cov=. --cov-report=xml
        
    - name: Build Docker images
      run: |
        echo "ğŸ³ Building Docker images..."
        docker build -f Dockerfile.platform -t symphainy-platform:${{ github.sha }} .
        docker tag symphainy-platform:${{ github.sha }} symphainy-platform:latest
        
    - name: Push to registry
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ“¦ Pushing to registry..."
        # docker push symphainy-platform:${{ github.sha }}
        # docker push symphainy-platform:latest
        echo "âœ… Images ready for deployment"

  # Deploy to Staging
  deploy-staging:
    runs-on: ubuntu-latest
    name: Deploy to Staging
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to staging
      run: |
        echo "ğŸš€ Deploying to staging..."
        echo "Environment: staging"
        echo "Image: symphainy-platform:${{ github.sha }}"
        
        # Start staging environment
        docker-compose -f docker-compose.dev.yml up -d
        
        # Wait for services
        sleep 30
        
        # Health check
        python3 monitoring/health-checks.py
        
    - name: Run staging tests
      run: |
        echo "ğŸ§ª Running staging tests..."
        # Add staging-specific tests here
        
    - name: Notify staging deployment
      run: |
        echo "ğŸ“¢ Staging deployment complete!"
        echo "ğŸŒ Staging URL: http://staging.symphainy.com"
        echo "ğŸ“Š Health: http://staging.symphainy.com/health"

  # Deploy to Production
  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to Production
    needs: [build-and-test, deploy-staging]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Load production secrets
      run: |
        echo "ğŸ” Loading production secrets..."
        chmod +x scripts/load-secrets.sh
        ./scripts/load-secrets.sh
        
    - name: Deploy to production
      run: |
        echo "ğŸš€ Deploying to production..."
        echo "Environment: production"
        echo "Image: symphainy-platform:${{ github.sha }}"
        
        # Start production environment
        docker-compose -f docker-compose.prod.yml up -d
        
        # Wait for services
        sleep 60
        
        # Health check
        python3 monitoring/health-checks.py
        
    - name: Run production tests
      run: |
        echo "ğŸ§ª Running production tests..."
        # Add production-specific tests here
        
    - name: Setup monitoring
      run: |
        echo "ğŸ“Š Setting up production monitoring..."
        # Start monitoring stack
        docker-compose -f docker-compose.monitoring.yml up -d
        
    - name: Notify production deployment
      run: |
        echo "ğŸ“¢ Production deployment complete!"
        echo "ğŸŒ Production URL: https://symphainy.com"
        echo "ğŸ“Š Health: https://symphainy.com/health"
        echo "ğŸ“ˆ Monitoring: https://monitoring.symphainy.com"

  # Rollback capability
  rollback:
    runs-on: ubuntu-latest
    name: Rollback
    if: failure()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Rollback deployment
      run: |
        echo "ğŸ”„ Rolling back deployment..."
        
        # Stop current deployment
        docker-compose -f docker-compose.prod.yml down
        
        # Deploy previous version
        docker-compose -f docker-compose.prod.yml up -d
        
        # Health check
        python3 monitoring/health-checks.py
        
    - name: Notify rollback
      run: |
        echo "ğŸ“¢ Rollback complete!"
        echo "ğŸ”„ Previous version restored"
        echo "ğŸ“Š Health: https://symphainy.com/health"




