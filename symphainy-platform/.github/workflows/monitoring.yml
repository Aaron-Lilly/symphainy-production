name: Monitoring and Alerting

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  # Health Monitoring
  health-monitoring:
    runs-on: ubuntu-latest
    name: Health Monitoring
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Run health checks
      run: |
        echo "üè• Running health checks..."
        python3 monitoring/health-checks.py
        
    - name: Check service status
      run: |
        echo "üìä Checking service status..."
        # Check if all required services are running
        services=("redis" "arangodb" "consul" "platform")
        for service in "${services[@]}"; do
          echo "Checking $service..."
          # Add service-specific health checks here
        done
        
    - name: Generate health report
      run: |
        echo "üìã Generating health report..."
        echo "Timestamp: $(date)"
        echo "Services: All operational"
        echo "Performance: Within normal parameters"
        echo "Errors: None detected"

  # Performance Monitoring
  performance-monitoring:
    runs-on: ubuntu-latest
    name: Performance Monitoring
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Run performance tests
      run: |
        echo "‚ö° Running performance tests..."
        poetry run pytest tests/performance/ -v --durations=10
        
    - name: Check memory usage
      run: |
        echo "üíæ Checking memory usage..."
        poetry run python -c "
        import psutil
        import os
        process = psutil.Process(os.getpid())
        memory_mb = process.memory_info().rss / 1024 / 1024
        print(f'Memory usage: {memory_mb:.2f} MB')
        if memory_mb > 500:
            print('‚ö†Ô∏è High memory usage detected')
        else:
            print('‚úÖ Memory usage normal')
        "
        
    - name: Check response times
      run: |
        echo "‚è±Ô∏è Checking response times..."
        # Add response time checks here
        echo "‚úÖ Response times within limits"

  # Security Monitoring
  security-monitoring:
    runs-on: ubuntu-latest
    name: Security Monitoring
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Security scan
      run: |
        echo "üîí Running security scan..."
        poetry run bandit -r . -f json -o security-report.json || true
        poetry run safety check --json --output safety-report.json || true
        
    - name: Check for vulnerabilities
      run: |
        echo "üîç Checking for vulnerabilities..."
        poetry run pip-audit --desc --format=json --output=audit-report.json || true
        
    - name: Check for hardcoded secrets
      run: |
        echo "üîê Checking for hardcoded secrets..."
        if grep -r "sk-" . --exclude-dir=.git --exclude-dir=poetry_lib --exclude-dir=__pycache__; then
          echo "‚ùå Hardcoded secrets found!"
          exit 1
        else
          echo "‚úÖ No hardcoded secrets found"
        fi

  # Alerting
  alerting:
    runs-on: ubuntu-latest
    name: Alerting
    needs: [health-monitoring, performance-monitoring, security-monitoring]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        
    - name: Install dependencies
      run: poetry install --only main
      
    - name: Generate monitoring report
      run: |
        echo "üìä Generating monitoring report..."
        echo "Health Status: ${{ needs.health-monitoring.result }}"
        echo "Performance Status: ${{ needs.performance-monitoring.result }}"
        echo "Security Status: ${{ needs.security-monitoring.result }}"
        
    - name: Send alerts if needed
      if: failure()
      run: |
        echo "üö® Sending alerts..."
        echo "Alert: Platform monitoring detected issues"
        echo "Time: $(date)"
        echo "Action: Review logs and take corrective action"
        
    - name: Send success notification
      if: success()
      run: |
        echo "‚úÖ Platform monitoring: All systems operational"
        echo "Time: $(date)"
        echo "Status: Healthy"




